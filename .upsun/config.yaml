applications:
  app:
    type: "php:8.2"
    
    runtime:
      extensions:
        - pdo_pgsql
        - mbstring
        - tokenizer
        - xml
        - ctype
        - curl
        - zip
        - bcmath
        - gd
        
    relationships:
      database: "db:postgresql"
    
    # Direktori yang perlu writable
    mounts:
      "storage":
        source: storage
        source_path: "storage"
      "bootstrap/cache":
        source: storage
        source_path: "bootstrap_cache"
      
    web:
      locations:
        "/":
          root: "public"
          passthru: "/index.php"
          index:
            - index.php
          scripts: true
          allow: true
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|woff2?)$:
              allow: true
              expires: 1y
        "/storage":
          root: "storage/app/public"
          scripts: false
          allow: true
      
    build:
      flavor: "composer"
      
    hooks:
      build: |
        set -e
        # Install dependencies
        composer install --no-dev --optimize-autoloader --no-interaction
        
      deploy: |
        set -e
        
        # Create complete storage structure
        mkdir -p storage/app/public
        mkdir -p storage/framework/cache/data
        mkdir -p storage/framework/sessions
        mkdir -p storage/framework/testing
        mkdir -p storage/framework/views
        mkdir -p storage/logs
        mkdir -p bootstrap/cache
        
        # Set proper permissions
        chmod -R 775 storage
        chmod -R 775 bootstrap/cache
        
        # Create symbolic link for public storage
        php artisan storage:link --force || true
        
        # Clear all caches first
        php artisan config:clear || true
        php artisan cache:clear || true
        php artisan route:clear || true
        php artisan view:clear || true
        
        # Run migrations
        php artisan migrate --force --no-interaction
        
        # Cache configs after migrations
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
    
    variables:
      env:
        APP_ENV: 'production'
        APP_KEY: 'base64:3k3MUaN/3TEL9a0hJYMS9+O7Dcb4ljQ4V7hA0xZf6dc='
        APP_DEBUG: 'false'
        LOG_CHANNEL: 'stderr'
        LOG_LEVEL: 'error'
        SESSION_DRIVER: 'file'
        CACHE_DRIVER: 'file'
        DB_CONNECTION: 'pgsql'
        VIEW_COMPILED_PATH: '/app/storage/framework/views'

routes:
  "https://{default}/":
    type: upstream
    upstream: "app:http"
    cache:
      enabled: true
      cookies: ['*']

services:
  db:
    type: postgresql:16